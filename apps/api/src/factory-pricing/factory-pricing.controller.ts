/**
 * ???????????????????????????????????????????????????????????????????????????
 * FACTORY PRICING CONTROLLER - API Gateway for Price Control
 * ???????????????????????????????????????????????????????????????????????????
 * Purpose: REST API for Factory Price Control Panel
 * Critical: RBAC enforcement (FACTORY role only)
 * Lock-in #1: Factory's only tool to control margin and volatility
 * ???????????????????????????????????????????????????????????????????????????
 */

import {
  Body,
  Controller,
  ForbiddenException,
  Get,
  Param,
  Post,
  Put,
  Request,
} from '@nestjs/common';
import { Decimal } from '@prisma/client/runtime/library';
import type { FactoryPricingService } from './factory-pricing.service';
import type {
  SetProductPricingDTO,
  SetTierDiscountRateDTO,
  UpdateVolatilityIndexDTO,
} from './factory-pricing.types';

@Controller('factory-pricing')
export class FactoryPricingController {
  constructor(private readonly pricingService: FactoryPricingService) {}

  /**
   * ???????????????????????????????????????????????????????????????????????????
   * POST /api/factory-pricing/volatility-index
   * ???????????????????????????????????????????????????????????????????????????
   * Purpose: Update volatility index for market conditions
   * RBAC: FACTORY_ADMIN or SYSTEM_ADMIN only
   * ???????????????????????????????????????????????????????????????????????????
   */
  @Post('volatility-index')
  async updateVolatilityIndex(@Request() req: any, @Body() body: UpdateVolatilityIndexDTO) {
    // Extract user from request (set by auth middleware)
    const actorId = req.user?.sub || req.user?.id || 'SYSTEM';
    const actorRole = req.user?.role || 'UNKNOWN';

    // RBAC Middleware Check (controller-level enforcement)
    if (actorRole !== 'FACTORY_ADMIN' && actorRole !== 'SYSTEM_ADMIN') {
      throw new ForbiddenException(
        'RBAC Violation: Only FACTORY_ADMIN or SYSTEM_ADMIN can update Volatility Index'
      );
    }

    const result = await this.pricingService.updateVolatilityIndex(body, actorId, actorRole);

    return result;
  }

  /**
   * ???????????????????????????????????????????????????????????????????????????
   * POST /api/factory-pricing/product/:productId/pricing
   * ???????????????????????????????????????????????????????????????????????????
   * Purpose: Set product base price and minimum allowed price (MarginGuard)
   * RBAC: FACTORY role only + Multi-Tenancy (factory can only edit own products)
   * ???????????????????????????????????????????????????????????????????????????
   */
  @Post('product/:productId/pricing')
  async setProductPricing(
    @Request() req: any,
    @Param('productId') productId: string,
    @Body() body: { factoryId: string; basePrice: string; minimumAllowedPrice: string }
  ) {
    // Extract user from request
    const actorId = req.user?.sub || req.user?.id || 'SYSTEM';
    const actorRole = req.user?.role || 'UNKNOWN';

    // RBAC Middleware Check (factory role only)
    if (actorRole !== 'FACTORY' && actorRole !== 'FACTORY_ADMIN' && actorRole !== 'SYSTEM_ADMIN') {
      throw new ForbiddenException('RBAC Violation: Only FACTORY role can update product pricing');
    }

    // Convert string prices to Decimal
    const data: SetProductPricingDTO = {
      factoryId: body.factoryId,
      productId,
      basePrice: new Decimal(body.basePrice),
      minimumAllowedPrice: new Decimal(body.minimumAllowedPrice),
    };

    const result = await this.pricingService.setProductPricing(data, actorId);

    return result;
  }

  /**
   * ???????????????????????????????????????????????????????????????????????????
   * PUT /api/factory-pricing/tier/:tierId/discount
   * ???????????????????????????????????????????????????????????????????????????
   * Purpose: Update discount rate for a price tier
   * RBAC: FACTORY role only + Multi-Tenancy (factory can only edit own tiers)
   * ???????????????????????????????????????????????????????????????????????????
   */
  @Put('tier/:tierId/discount')
  async setTierDiscountRate(
    @Request() req: any,
    @Param('tierId') tierId: string,
    @Body() body: { factoryId: string; discountRate: number }
  ) {
    // Extract user from request
    const actorId = req.user?.sub || req.user?.id || 'SYSTEM';
    const actorRole = req.user?.role || 'UNKNOWN';

    // RBAC Middleware Check
    if (actorRole !== 'FACTORY' && actorRole !== 'FACTORY_ADMIN' && actorRole !== 'SYSTEM_ADMIN') {
      throw new ForbiddenException(
        'RBAC Violation: Only FACTORY role can update tier discount rates'
      );
    }

    const data: SetTierDiscountRateDTO = {
      factoryId: body.factoryId,
      tierId,
      discountRate: body.discountRate,
    };

    const result = await this.pricingService.setTierDiscountRate(data, actorId);

    return result;
  }

  /**
   * ???????????????????????????????????????????????????????????????????????????
   * GET /api/factory-pricing/products/:factoryId
   * ???????????????????????????????????????????????????????????????????????????
   * Purpose: Get all products for a factory with pricing info
   * Used by: Factory Price Control Panel UI
   * ???????????????????????????????????????????????????????????????????????????
   */
  @Get('products/:factoryId')
  async getFactoryProducts(@Request() req: any, @Param('factoryId') factoryId: string) {
    const actorRole = req.user?.role || 'UNKNOWN';

    // RBAC: Only factory or admin can view products
    if (actorRole !== 'FACTORY' && actorRole !== 'FACTORY_ADMIN' && actorRole !== 'SYSTEM_ADMIN') {
      throw new ForbiddenException('RBAC Violation: Insufficient permissions');
    }

    const products = await this.pricingService.getFactoryProducts(factoryId);

    return { success: true, products };
  }

  /**
   * ???????????????????????????????????????????????????????????????????????????
   * GET /api/factory-pricing/volatility-indexes/:factoryId
   * ???????????????????????????????????????????????????????????????????????????
   * Purpose: Get all volatility indexes for a factory
   * Used by: Factory Price Control Panel UI
   * ???????????????????????????????????????????????????????????????????????????
   */
  @Get('volatility-indexes/:factoryId')
  async getVolatilityIndexes(@Request() req: any, @Param('factoryId') factoryId: string) {
    const actorRole = req.user?.role || 'UNKNOWN';

    // RBAC: Only factory or admin can view indexes
    if (actorRole !== 'FACTORY' && actorRole !== 'FACTORY_ADMIN' && actorRole !== 'SYSTEM_ADMIN') {
      throw new ForbiddenException('RBAC Violation: Insufficient permissions');
    }

    const indexes = await this.pricingService.getVolatilityIndexes(factoryId);

    return { success: true, indexes };
  }

  /**
   * ???????????????????????????????????????????????????????????????????????????
   * GET /api/factory-pricing/tiers/:factoryId
   * ???????????????????????????????????????????????????????????????????????????
   * Purpose: Get all price tiers for a factory
   * Used by: Factory Price Control Panel UI
   * ???????????????????????????????????????????????????????????????????????????
   */
  @Get('tiers/:factoryId')
  async getPriceTiers(@Request() req: any, @Param('factoryId') factoryId: string) {
    const actorRole = req.user?.role || 'UNKNOWN';

    // RBAC: Only factory or admin can view tiers
    if (actorRole !== 'FACTORY' && actorRole !== 'FACTORY_ADMIN' && actorRole !== 'SYSTEM_ADMIN') {
      throw new ForbiddenException('RBAC Violation: Insufficient permissions');
    }

    const tiers = await this.pricingService.getPriceTiers(factoryId);

    return { success: true, tiers };
  }
}
