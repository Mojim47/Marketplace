apiVersion: batch/v1
kind: CronJob
metadata:
  name: db-backup
  namespace: nextgen
spec:
  schedule: "0 2 * * *"
  jobTemplate:
    spec:
      template:
        spec:
          serviceAccountName: backup-sa
          containers:
          - name: backup
            image: postgres:16-alpine
            command:
              - /bin/bash
              - -c
              - |
                #!/bin/bash
                set -e
                BACKUP_DIR="/backup"
                TIMESTAMP=$(date +%Y%m%d_%H%M%S)
                BACKUP_FILE="$BACKUP_DIR/dump-$TIMESTAMP.sql.gz"
                
                echo "Starting database backup..."
                pg_dump -h postgres -U postgres -d marketplace_prod | gzip > "$BACKUP_FILE"
                echo "Backup saved to $BACKUP_FILE"
                
                # Keep only last 7 backups
                cd "$BACKUP_DIR"
                ls -t dump-*.sql.gz | tail -n +8 | xargs -r rm -v
                echo "Cleanup complete"
            env:
            - name: PGPASSWORD
              valueFrom:
                secretKeyRef:
                  name: app-secrets
                  key: DB_PASSWORD
            volumeMounts:
            - name: backup-storage
              mountPath: /backup
          restartPolicy: OnFailure
          volumes:
          - name: backup-storage
            emptyDir: {}
---
apiVersion: batch/v1
kind: CronJob
metadata:
  name: cache-warmup
  namespace: nextgen
spec:
  schedule: "*/30 * * * *"
  jobTemplate:
    spec:
      template:
        spec:
          containers:
          - name: warmup
            image: curlimages/curl:7.85.0
            command:
              - /bin/sh
              - -c
              - |
                echo "Warming up cache..."
                curl -s http://api-service/api/health > /dev/null
                curl -s http://api-service/api/ready > /dev/null
                echo "Cache warmup complete"
          restartPolicy: OnFailure
---
apiVersion: v1
kind: ServiceAccount
metadata:
  name: backup-sa
  namespace: nextgen
