// This is your Prisma schema file for NextGen Marketplace

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ============================================
// 1. USER MANAGEMENT
// ============================================

model User {
  id        String   @id @default(cuid())
  email     String   @unique @db.VarChar(255)
  password  String   @db.VarChar(255)
  first_name String? @db.VarChar(100)
  last_name  String? @db.VarChar(100)
  phone     String?  @db.VarChar(20)
  is_active Boolean  @default(true)
  created_at DateTime @default(now())
  updated_at DateTime @updatedAt

  // Relations
  orders    Order[]
  cart      Cart?
  reviews   Review[]
  addresses Address[]
  wishlist  Wishlist[]

  @@index([email])
  @@index([phone])
  @@map("users")
}

model Address {
  id        String   @id @default(cuid())
  user_id   String
  province  String   @db.VarChar(50)
  city      String   @db.VarChar(50)
  street    String   @db.VarChar(255)
  postal_code String @db.VarChar(10)
  is_default Boolean @default(false)
  created_at DateTime @default(now())

  user      User     @relation(fields: [user_id], references: [id], onDelete: Cascade)

  @@index([user_id])
  @@map("addresses")
}

// ============================================
// 2. CATALOG
// ============================================

model Category {
  id        String   @id @default(cuid())
  name      String   @db.VarChar(100)
  slug      String   @unique @db.VarChar(100)
  description String?
  parent_id String?
  created_at DateTime @default(now())

  parent    Category?  @relation("CategoryHierarchy", fields: [parent_id], references: [id])
  children  Category[] @relation("CategoryHierarchy")
  products  Product[]

  @@map("categories")
}

model Vendor {
  id        String   @id @default(cuid())
  name      String   @db.VarChar(255)
  email     String?  @db.VarChar(255)
  phone     String?  @db.VarChar(20)
  commission_rate Decimal @default(10) @db.Decimal(5, 2)
  is_active Boolean  @default(true)
  created_at DateTime @default(now())

  products  Product[]

  @@map("vendors")
}

model Product {
  id        String   @id @default(cuid())
  category_id String
  vendor_id String
  sku       String   @unique @db.VarChar(50)
  name      String   @db.VarChar(255)
  description String?
  price     Decimal  @db.Decimal(10, 2)
  stock     Int      @default(0)
  status    String   @default("DRAFT") // DRAFT, ACTIVE, OUT_OF_STOCK
  created_at DateTime @default(now())
  updated_at DateTime @updatedAt

  category   Category   @relation(fields: [category_id], references: [id])
  vendor     Vendor     @relation(fields: [vendor_id], references: [id])
  reviews    Review[]
  order_items OrderItem[]
  cart_items CartItem[]
  wishlists  Wishlist[]

  @@index([category_id])
  @@index([vendor_id])
  @@index([status])
  @@map("products")
}

// ============================================
// 3. SHOPPING CART & WISHLIST
// ============================================

model Cart {
  id        String   @id @default(cuid())
  user_id   String   @unique
  created_at DateTime @default(now())
  updated_at DateTime @updatedAt

  user      User       @relation(fields: [user_id], references: [id], onDelete: Cascade)
  items     CartItem[]

  @@map("carts")
}

model CartItem {
  id        String   @id @default(cuid())
  cart_id   String
  product_id String
  quantity  Int      @default(1)
  created_at DateTime @default(now())

  cart      Cart     @relation(fields: [cart_id], references: [id], onDelete: Cascade)
  product   Product  @relation(fields: [product_id], references: [id])

  @@unique([cart_id, product_id])
  @@map("cart_items")
}

model Wishlist {
  id        String   @id @default(cuid())
  user_id   String
  product_id String
  created_at DateTime @default(now())

  user      User     @relation(fields: [user_id], references: [id], onDelete: Cascade)
  product   Product  @relation(fields: [product_id], references: [id])

  @@unique([user_id, product_id])
  @@map("wishlists")
}

// ============================================
// 4. ORDERS & PAYMENTS
// ============================================

model Order {
  id        String   @id @default(cuid())
  user_id   String
  order_number String @unique @db.VarChar(20)
  status    String   @default("PENDING") // PENDING, PAID, PROCESSING, SHIPPED, DELIVERED, COMPLETED
  total_amount Decimal @db.Decimal(10, 2)
  created_at DateTime @default(now())
  updated_at DateTime @updatedAt

  user      User        @relation(fields: [user_id], references: [id])
  items     OrderItem[]
  payment   Payment?

  @@index([user_id])
  @@index([status])
  @@index([created_at])
  @@map("orders")
}

model OrderItem {
  id        String   @id @default(cuid())
  order_id  String
  product_id String
  quantity  Int
  unit_price Decimal  @db.Decimal(10, 2)
  total_price Decimal @db.Decimal(10, 2)
  created_at DateTime @default(now())

  order     Order    @relation(fields: [order_id], references: [id], onDelete: Cascade)
  product   Product  @relation(fields: [product_id], references: [id])

  @@index([order_id])
  @@map("order_items")
}

model Payment {
  id        String   @id @default(cuid())
  order_id  String   @unique
  amount    Decimal  @db.Decimal(10, 2)
  status    String   @default("PENDING") // PENDING, COMPLETED, FAILED
  gateway   String   @db.VarChar(50) // ZARINPAL, MELLAT, SAMAN
  transaction_id String? @db.VarChar(100)
  created_at DateTime @default(now())
  updated_at DateTime @updatedAt

  order     Order    @relation(fields: [order_id], references: [id], onDelete: Cascade)

  @@map("payments")
}

// ============================================
// 5. REVIEWS & RATINGS
// ============================================

model Review {
  id        String   @id @default(cuid())
  product_id String
  user_id   String
  rating    Int      // 1-5
  comment   String?
  created_at DateTime @default(now())

  product   Product  @relation(fields: [product_id], references: [id], onDelete: Cascade)
  user      User     @relation(fields: [user_id], references: [id], onDelete: Cascade)

  @@unique([product_id, user_id])
  @@index([product_id])
  @@map("reviews")
}
