# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# NextGen Marketplace - Production Deployment Pipeline
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# Enterprise-grade production deployment with full security scanning
# Triggers: push to main, manual dispatch
# Stages: security-scan â†’ test â†’ build â†’ deploy
# Requirements: 1.1, 1.2, 1.3, 1.4, 1.6, 1.7, 2.2, 2.3, 2.4
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

name: "ðŸš€ Production Deployment"

on:
  push:
    branches: [main]
  workflow_dispatch:

env:
  NODE_VERSION: "20.18.1"
  PNPM_VERSION: "9.15.1"
  # Required health endpoints for deploy gating
  API_HEALTH_URL: ${{ secrets.API_HEALTH_URL }}
  WEB_HEALTH_URL: ${{ secrets.WEB_HEALTH_URL }}
  ADMIN_HEALTH_URL: ${{ secrets.ADMIN_HEALTH_URL }}

concurrency:
  group: production-deploy-${{ github.ref }}
  cancel-in-progress: false

jobs:
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  # STAGE 1: Security Scanning (MUST PASS - No continue-on-error)
  # Requirements: 2.2, 2.3, 2.4
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  security-scan:
    name: "ðŸ”’ Security Scan"
    runs-on: ubuntu-latest
    permissions:
      contents: read
      security-events: write
    steps:
      - name: "ðŸ“¥ Checkout code"
        uses: actions/checkout@v6

      - name: "ðŸ“¦ Setup pnpm"
        uses: pnpm/action-setup@v2
        with:
          version: ${{ env.PNPM_VERSION }}

      - name: "ðŸŸ¢ Setup Node.js"
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: "pnpm"

      - name: "ðŸ“¥ Install dependencies"
        run: pnpm install --frozen-lockfile

      # Trivy Filesystem Scan - MUST PASS
      - name: "ðŸ›¡ï¸ Run Trivy vulnerability scanner"
        uses: aquasecurity/trivy-action@master
        with:
          scan-type: "fs"
          scan-ref: "."
          format: "sarif"
          output: "trivy-results.sarif"
          severity: "CRITICAL,HIGH"
          exit-code: "1"  # Fail on CRITICAL/HIGH

      - name: "ðŸ“¤ Upload Trivy results"
        uses: github/codeql-action/upload-sarif@v3
        if: always()
        with:
          sarif_file: "trivy-results.sarif"
          category: "trivy-production"

      # Gitleaks Secret Scan - MUST PASS
      - name: "ðŸ”‘ Run Gitleaks secret scan"
        uses: gitleaks/gitleaks-action@v2
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        # No continue-on-error - secrets MUST block deployment

      # pnpm Audit - MUST PASS for HIGH/CRITICAL
      - name: "ðŸ“¦ Run pnpm audit"
        run: pnpm audit --audit-level=high
        # No continue-on-error - vulnerabilities MUST block deployment

  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  # STAGE 2: Full Test Suite
  # Requirements: 1.6
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  test:
    name: "ðŸ§ª Full Test Suite"
    runs-on: ubuntu-latest
    needs: security-scan
    services:
      postgres:
        image: postgres:16-alpine
        env:
          POSTGRES_USER: test
          POSTGRES_PASSWORD: test
          POSTGRES_DB: nextgen_test
        ports:
          - 5432:5432
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
      redis:
        image: redis:7-alpine
        ports:
          - 6379:6379
        options: >-
          --health-cmd "redis-cli ping"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
    steps:
      - name: "ðŸ“¥ Checkout code"
        uses: actions/checkout@v6

      - name: "ðŸ“¦ Setup pnpm"
        uses: pnpm/action-setup@v2
        with:
          version: ${{ env.PNPM_VERSION }}

      - name: "ðŸŸ¢ Setup Node.js"
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: "pnpm"

      - name: "ðŸ“¥ Install dependencies"
        run: pnpm install --frozen-lockfile

      - name: "ðŸ”§ Generate Prisma client"
        run: pnpm run db:generate

      - name: "ðŸ—„ï¸ Run database migrations"
        run: pnpm run db:migrate:deploy
        env:
          DATABASE_URL: postgresql://test:test@localhost:5432/nextgen_test

      - name: "ðŸ§ª Run unit tests"
        run: pnpm run test:unit --coverage
        env:
          NODE_ENV: test
          DATABASE_URL: postgresql://test:test@localhost:5432/nextgen_test
          REDIS_URL: redis://localhost:6379
          JWT_SECRET: test-jwt-secret-for-ci-pipeline-minimum-32-chars
          JWT_REFRESH_SECRET: test-refresh-secret-for-ci-pipeline-32-chars

      - name: "ðŸŽ² Run property-based tests"
        run: pnpm run test:pbt
        env:
          NODE_ENV: test
          JWT_SECRET: test-jwt-secret-for-ci-pipeline-minimum-32-chars
          JWT_REFRESH_SECRET: test-refresh-secret-for-ci-pipeline-32-chars

      - name: "ðŸ”— Run integration tests"
        run: pnpm run test:integration
        env:
          NODE_ENV: test
          DATABASE_URL: postgresql://test:test@localhost:5432/nextgen_test
          REDIS_URL: redis://localhost:6379
          JWT_SECRET: test-jwt-secret-for-ci-pipeline-minimum-32-chars
          JWT_REFRESH_SECRET: test-refresh-secret-for-ci-pipeline-32-chars

      - name: "ðŸ“Š Upload coverage"
        uses: codecov/codecov-action@v4
        with:
          files: ./coverage/lcov.info
          fail_ci_if_error: false
          token: ${{ secrets.CODECOV_TOKEN }}

  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  # STAGE 3: Build Application
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  build:
    name: "ðŸ—ï¸ Build Application"
    runs-on: ubuntu-latest
    needs: test
    steps:
      - name: "ðŸ“¥ Checkout code"
        uses: actions/checkout@v6

      - name: "ðŸ“¦ Setup pnpm"
        uses: pnpm/action-setup@v2
        with:
          version: ${{ env.PNPM_VERSION }}

      - name: "ðŸŸ¢ Setup Node.js"
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: "pnpm"

      - name: "ðŸ“¥ Install dependencies"
        run: pnpm install --frozen-lockfile

      - name: "ðŸ”§ Generate Prisma client"
        run: pnpm run db:generate

      - name: "ðŸš« Check for mock files in source"
        run: node scripts/check-mock-files.mjs

      - name: "ðŸ—ï¸ Build application"
        run: pnpm run build
        env:
          NODE_ENV: production

      - name: "ðŸš« Verify no mock files in build output"
        run: node scripts/check-mock-files.mjs

      - name: "ðŸ“¤ Upload build artifacts"
        uses: actions/upload-artifact@v4
        with:
          name: production-build
          path: |
            dist/
            apps/*/dist/
            apps/*/.next/
          retention-days: 7

  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  # STAGE 4: Docker Build & Push
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  docker:
    name: "ðŸ³ Docker Build & Push"
    runs-on: ubuntu-latest
    needs: build
    permissions:
      contents: read
      packages: write
    steps:
      - name: "ðŸ“¥ Checkout code"
        uses: actions/checkout@v6

      - name: "ðŸ³ Set up Docker Buildx"
        uses: docker/setup-buildx-action@v3

      - name: "ðŸ” Log in to Container Registry"
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: "ðŸ“ Extract metadata"
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: ghcr.io/${{ github.repository }}
          tags: |
            type=sha,prefix=
            type=raw,value=latest,enable={{is_default_branch}}
            type=semver,pattern={{version}}

      # Scan Docker image before push
      - name: "ðŸ›¡ï¸ Build image for scanning"
        uses: docker/build-push-action@v5
        with:
          context: .
          file: ./Dockerfile
          push: false
          load: true
          tags: nextgen-scan:latest
          target: api

      - name: "ðŸ›¡ï¸ Scan Docker image with Trivy"
        uses: aquasecurity/trivy-action@master
        with:
          image-ref: nextgen-scan:latest
          format: "sarif"
          output: "trivy-image-results.sarif"
          severity: "CRITICAL,HIGH"
          exit-code: "1"  # Fail on vulnerabilities

      - name: "ðŸš€ Build and push Docker images"
        uses: docker/build-push-action@v5
        with:
          context: .
          file: ./Dockerfile
          push: true
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}
          cache-from: type=gha
          cache-to: type=gha,mode=max
          build-args: |
            VERSION=${{ github.sha }}
            BUILD_DATE=${{ github.event.head_commit.timestamp }}
            VCS_REF=${{ github.sha }}

  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  # STAGE 5: Deploy to Production
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  deploy:
    name: "ðŸš€ Deploy to Production"
    runs-on: ubuntu-latest
    needs: docker
    environment:
      name: production
      url: https://api.nextgen-market.ir
    steps:
      - name: "ðŸ“¥ Checkout code"
        uses: actions/checkout@v6

      - name: "ðŸš€ Deploy to production"
        run: |
          echo "ðŸš€ Deploying to production..."
          echo "Image: ghcr.io/${{ github.repository }}:${{ github.sha }}"
          # Add actual deployment commands here
          # kubectl set image deployment/api api=ghcr.io/${{ github.repository }}:${{ github.sha }}

      - name: "ðŸ¥ Run health checks (gate)"
        run: |
          : "${API_HEALTH_URL:?Missing API_HEALTH_URL secret}"
          : "${WEB_HEALTH_URL:?Missing WEB_HEALTH_URL secret}"
          : "${ADMIN_HEALTH_URL:?Missing ADMIN_HEALTH_URL secret}"
          echo "ðŸ¥ Running health checks..."
          curl -f "$API_HEALTH_URL" || exit 1
          curl -f "$WEB_HEALTH_URL" || exit 1
          curl -f "$ADMIN_HEALTH_URL" || exit 1

      - name: "âœ… Deployment complete"
        run: echo "âœ… Production deployment successful!"

  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  # STAGE 6: Post-Deploy Verification
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  verify:
    name: "âœ… Post-Deploy Verification"
    runs-on: ubuntu-latest
    needs: deploy
    steps:
      - name: "ðŸ¥ Verify API health"
        run: |
          echo "Verifying API health..."
          : "${API_HEALTH_URL:?Missing API_HEALTH_URL secret}"
          : "${WEB_HEALTH_URL:?Missing WEB_HEALTH_URL secret}"
          : "${ADMIN_HEALTH_URL:?Missing ADMIN_HEALTH_URL secret}"
          curl -f "$API_HEALTH_URL" || exit 1
          curl -f "$WEB_HEALTH_URL" || exit 1
          curl -f "$ADMIN_HEALTH_URL" || exit 1

      - name: "ðŸ“Š Generate deployment summary"
        run: |
          echo "## ðŸš€ Production Deployment Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Item | Value |" >> $GITHUB_STEP_SUMMARY
          echo "|------|-------|" >> $GITHUB_STEP_SUMMARY
          echo "| ðŸ”’ Security Scan | âœ… Passed |" >> $GITHUB_STEP_SUMMARY
          echo "| ðŸ§ª Tests | âœ… Passed |" >> $GITHUB_STEP_SUMMARY
          echo "| ðŸ—ï¸ Build | âœ… Passed |" >> $GITHUB_STEP_SUMMARY
          echo "| ðŸ³ Docker | âœ… Pushed |" >> $GITHUB_STEP_SUMMARY
          echo "| ðŸš€ Deploy | âœ… Complete |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Commit:** \`${{ github.sha }}\`" >> $GITHUB_STEP_SUMMARY
          echo "**Triggered by:** @${{ github.actor }}" >> $GITHUB_STEP_SUMMARY
