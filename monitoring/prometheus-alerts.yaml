groups:
- name: nextgen-slo-alerts
  rules:
  - alert: HighErrorBudgetBurnRate
    expr: |
      (
        (
          sum(rate(http_requests_total{job="nextgen-api",code=~"5.."}[1m])) /
          sum(rate(http_requests_total{job="nextgen-api"}[1m]))
        ) > (14.4 * 0.001)
      ) and (
        (
          sum(rate(http_requests_total{job="nextgen-api",code=~"5.."}[5m])) /
          sum(rate(http_requests_total{job="nextgen-api"}[5m]))
        ) > (14.4 * 0.001)
      )
    for: 2m
    labels:
      severity: critical
      service: nextgen-api
      slo: availability
    annotations:
      summary: "High error budget burn rate detected"
      description: "Error budget is burning at {{ $value }}x the acceptable rate. Current error rate: {{ $value | humanizePercentage }}"
      runbook_url: "https://runbooks.nextgen-market.ir/slo-burn-rate"

  - alert: HealthCheckFailure
    expr: up{job="nextgen-api"} == 0
    for: 30s
    labels:
      severity: critical
      service: nextgen-api
    annotations:
      summary: "Service health check failing"
      description: "Health check for {{ $labels.instance }} has been failing for more than 30 seconds"

  - alert: HighLatency
    expr: histogram_quantile(0.99, rate(http_request_duration_seconds_bucket{job="nextgen-api"}[5m])) > 1.0
    for: 5m
    labels:
      severity: warning
      service: nextgen-api
    annotations:
      summary: "High request latency"
      description: "99th percentile latency is {{ $value }}s for {{ $labels.instance }}"

  - alert: ErrorBudgetExhaustion
    expr: |
      (
        1 - (
          sum(rate(http_requests_total{job="nextgen-api",code!~"5.."}[30d])) /
          sum(rate(http_requests_total{job="nextgen-api"}[30d]))
        )
      ) > 0.001
    for: 1m
    labels:
      severity: warning
      service: nextgen-api
      slo: availability
    annotations:
      summary: "SLO error budget exhausted"
      description: "Monthly error budget of 0.1% has been exceeded. Current error rate: {{ $value | humanizePercentage }}"